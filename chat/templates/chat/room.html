<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

    <meta charset="utf-8"/>
    <title>Chat Room</title>
</head>
<body>
  <head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
  <nav class="navbar navbar-dark bg-primary">
  <a class="navbar-brand">Chatting App</a>
  <form class="form-inline">
    <input class="form-control mr-sm-2" type="search" placeholder="Find Friends" aria-label="Search">
    <button class="btn btn-outline-success " type="submit">Search</button>
  </form>
  </nav>
    <input id="chat-log" cols="100" rows="20" style="width: 500px; height: 250px; value="" onChange="function(text)"><br/>
    <input id="chat-message-input"></input><br/>
    <input id="chat-message-submit" type="button" value="Send"/>
    <button id="go">Sound</button>
    <p id="result-text"></p>
</body>
<script>
    var roomName = {{ room_name_json }};

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        document.querySelector('#chat-log').value += (message + '\n');
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));

        messageInputDom.value = '';
    };
</script>
<script type="text/javascript">

function morse(input) {
 const
    audioContext = new (window.AudioContext || window.webkitAudioContext),
    outputType = ['audio', 'vibrate', 'blink'],
    dit = 65, // base length of signal
    dah = dit * 3,
    symbolSpace = dit,
    letterSpace = dah,
    wordSpace = dit * 7,
    toneFrequency = 600, //Hz
    morseChars = {
      " "  : "/",
      "a"  : "Â·âˆ’",
      "b"  : "âˆ’Â·Â·Â·",
      "c"  : "âˆ’Â·âˆ’Â·",
      "d"  : "âˆ’Â·Â·",
      "e"  : "Â·",
      "f"  : "Â·Â·âˆ’Â·",
      "g"  : "âˆ’âˆ’Â·",
      "h"  : "Â·Â·Â·Â·",
      "i"  : "Â·Â·",
      "j"  : "Â·âˆ’âˆ’âˆ’",
      "k"  : "âˆ’Â·âˆ’",
      "l"  : "Â·âˆ’Â·Â·",
      "m"  : "âˆ’âˆ’",
      "n"  : "âˆ’Â·",
      "o"  : "âˆ’âˆ’âˆ’",
      "p"  : "Â·âˆ’âˆ’Â·",
      "q"  : "âˆ’âˆ’Â·âˆ’",
      "r"  : "Â·âˆ’Â·",
      "s"  : "Â·Â·Â·",
      "t"  : "âˆ’",
      "u"  : "Â·Â·âˆ’",
      "v"  : "Â·Â·Â·âˆ’",
      "w"  : "Â·âˆ’âˆ’",
      "x"  : "âˆ’Â·Â·âˆ’",
      "y"  : "âˆ’Â·âˆ’âˆ’",
      "z"  : "âˆ’âˆ’Â·Â·",
      "1"  : "Â·âˆ’âˆ’âˆ’âˆ’",
      "2"  : "Â·Â·âˆ’âˆ’âˆ’",
      "3"  : "Â·Â·Â·âˆ’âˆ’",
      "4"  : "Â·Â·Â·Â·âˆ’",
      "5"  : "Â·Â·Â·Â·Â·",
      "6"  : "âˆ’Â·Â·Â·Â·",
      "7"  : "âˆ’âˆ’Â·Â·Â·",
      "8"  : "âˆ’âˆ’âˆ’Â·Â·",
      "9"  : "âˆ’âˆ’âˆ’âˆ’Â·",
      "0"  : "âˆ’âˆ’âˆ’âˆ’âˆ’",
      "Ã "  : "Â·âˆ’âˆ’Â·âˆ’",
      "Ã¤"  : "Â·âˆ’Â·âˆ’",
      "Ã¨"  : "Â·âˆ’Â·Â·âˆ’",
      "Ã©"  : "Â·Â·âˆ’Â·Â·",
      "Ã¶"  : "âˆ’âˆ’âˆ’Â·",
      "Ã¼"  : "Â·Â·âˆ’âˆ’",
      "ÃŸ"  : "Â·Â·Â·âˆ’âˆ’Â·Â·",
      "Ã±"  : "âˆ’âˆ’Â·âˆ’âˆ’",
      "."	 : "Â·âˆ’Â·âˆ’Â·âˆ’",
      ","	 : "âˆ’âˆ’Â·Â·âˆ’âˆ’",
      ":"	 : "âˆ’âˆ’âˆ’Â·Â·Â·",
      ";"	 : "âˆ’Â·âˆ’Â·âˆ’Â·",
      "?"	 : "Â·Â·âˆ’âˆ’Â·Â·",
      "-"	 : "âˆ’Â·Â·Â·Â·âˆ’",
      "_"  : "Â·Â·âˆ’âˆ’Â·âˆ’",
      "("	 : "âˆ’Â·âˆ’âˆ’Â·",
      ")"	 : "âˆ’Â·âˆ’âˆ’Â·âˆ’",
      "'"	 : "Â·âˆ’âˆ’âˆ’âˆ’Â·",
      "="	 : "âˆ’Â·Â·Â·âˆ’",
      "+"	 : "Â·âˆ’Â·âˆ’Â·",
      "/"	 : "âˆ’Â·Â·âˆ’Â·",
      "@"	 : "Â·âˆ’âˆ’Â·âˆ’Â·"
    };

  if (outputType.includes('audio') && !AudioContext) {
      alert("Sorry! No audio in your browser ðŸ˜¢");
      return;
  }

  function inputToMorse(input) {
    if (!input) {return;}
    const characters = input.toLowerCase().trim().split('');
    let output = [];
    characters.forEach(character => {
      if (morseChars[character]) {
        output.push(morseChars[character]);
      }
    });
    return output;
  }

  function morseCodeToTime(input) {
    let output = []; // Alternating beep and silence lenghts
    let morseCode = inputToMorse(input);
    morseCode.forEach((set, index) => {
      let singleCharacters = set.split('');
      singleCharacters.forEach(char => {
        switch (char) {
          case "/":
            output.pop();
            output.push(wordSpace);
            break;
          case "Â·":
            output.push(dit, symbolSpace);
            break;
          case "âˆ’":
            output.push(dah, symbolSpace);
            break;
        }
      });
      if (output.slice(-1)[0] !== wordSpace) {
        output.pop();
        output.push(letterSpace);
      }
    });
    return output;
  }

  function playSound(sequence) {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)(),
    oscillator = audioCtx.createOscillator();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(toneFrequency, audioCtx.currentTime);
    let time = audioCtx.currentTime;

    let gainNode = audioCtx.createGain();
    gainNode.gain.setValueAtTime(0, time);

    sequence.forEach(function(symbol, index) {
        if (index % 2) {
          gainNode.gain.setValueAtTime(0, time);
          time += symbol / 1000;
        } else {
          gainNode.gain.setValueAtTime(1, time);
          time += symbol / 1000;
        }
    });
    oscillator.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    oscillator.start();
  }

  function runSequence(input) {
    let timeSequence = morseCodeToTime(input);
    navigator.vibrate(timeSequence);
    playSound(timeSequence);
  };
  runSequence(input);
};

(function(){
  document.getElementById("go").addEventListener('click', function(){
    let input = document.querySelector('#chat-log').value;
    morse(input);
  });
})();
</script>

</html>
